name: Deploy Vehicles Service

on:
  push:
    branches:
      - dev
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '8.0.101'

      - name: Restore dependencies
        run: dotnet restore ./Vehicles.csproj

      - name: Build
        run: dotnet build --configuration Release ./Vehicles.csproj

      - name: Publish
        run: dotnet publish Vehicles.csproj -c Release -r linux-x64 --self-contained -o ./publish/vehicles

      - name: Package Deployment Bundle
        run: |
          cd ./publish/vehicles
          zip -r ../../Vehicles-deployment.zip *

      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Transfer Deployment Package to EC2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          aws ec2 describe-instances --filters "Name=tag:Name,Values=Vehicles-Instance" --query "Reservations[*].Instances[*].PublicIpAddress" --output text > ec2-ip.txt
          sshpass -p "${{ secrets.VM_PASSWORD }}" scp -o StrictHostKeyChecking=no ./Vehicles-deployment.zip ubuntu@$(cat ec2-ip.txt):/home/ubuntu/

      - name: Deploy on EC2
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o StrictHostKeyChecking=no ubuntu@$(cat ec2-ip.txt) << 'EOF'
          unzip /home/ubuntu/Vehicles-deployment.zip -d /home/ubuntu/vehicles/
          cd /home/ubuntu/vehicles/
          ./Vehicles &
          EOF
